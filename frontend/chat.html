<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>AI Chat Hub</title>
  <script>
    // IMMEDIATE tenant check - block page load if validation fails
    (async function() {
      const ALLOWED_TENANT = 'a157a1e5-2a04-45f5-9ca8-bd60db6bafd4';
      try {
        const res = await fetch('/.auth/me');
        const data = await res.json();
        
        if (!data.clientPrincipal) {
          window.location.replace('/');
          return;
        }
        
        // Check for personal accounts by email domain
        const userId = data.clientPrincipal.userId || '';
        const personalDomains = ['hotmail.com', 'gmail.com', 'outlook.com', 'live.com', 'yahoo.com'];
        const isPersonalAccount = personalDomains.some(domain => userId.toLowerCase().includes(domain));
        
        if (isPersonalAccount) {
          console.error('Personal account detected:', userId);
          await fetch('/.auth/logout');
          window.location.replace('/access-denied.html');
          return;
        }
        
        // Check tenant ID from claims
        const claims = data.clientPrincipal.claims || [];
        const tidClaim = claims.find(c => c.typ?.includes('tenantid') || c.typ === 'tid');
        const tenantId = tidClaim ? tidClaim.val : null;
        
        if (tenantId && tenantId.toLowerCase() !== ALLOWED_TENANT.toLowerCase()) {
          console.error('Wrong tenant:', tenantId);
          await fetch('/.auth/logout');
          window.location.replace('/access-denied.html');
          return;
        }
      } catch (err) {
        console.error('Auth check failed:', err);
        window.location.replace('/');
      }
    })();
  </script>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <main>
    <header>
      <div>
        <h1>AI Chat Hub</h1>
        <div id="userInfo" style="font-size:0.85rem; color:#666;"></div>
      </div>
      <div style="display:flex; gap:0.5rem; align-items:center;">
        <select id="modelSelect">
          <option value="gpt-5-chat">GPT-5 Chat</option>
          <option value="gpt-35-turbo">GPT-3.5 Turbo</option>
        </select>
        <a href="/.auth/logout" style="padding:0.5rem 1rem; background:#dc3545; color:#fff; text-decoration:none; border-radius:4px; font-size:0.9rem;">Logout</a>
      </div>
    </header>
    <section id="chat"></section>
    <form id="promptForm">
      <textarea id="promptInput" placeholder="Ask anything..." required></textarea>
      <button type="submit">Send</button>
    </form>
  </main>
  <script>
    // Basic auth check - detailed validation happens in app.js
    (async function() {
      try {
        const res = await fetch('/.auth/me');
        const data = await res.json();
        
        if (!data.clientPrincipal || !data.clientPrincipal.userRoles.includes('authenticated')) {
          window.location.replace('/');
          return;
        }
      } catch (err) {
        window.location.replace('/');
        return;
      }
    })();
  </script>
  <script src="app.js"></script>
</body>
</html>
